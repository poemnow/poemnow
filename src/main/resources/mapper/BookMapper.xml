<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.cgm.poemnow.mapper.BookMapper" >

    <resultMap id="bookMap" type="com.cgm.poemnow.domain.Book">
        <result column="id" property="id"/>
        <result column="title" property="title"/>
        <result column="author" property="author"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="published" property="published"/>
        <result column="published_at" property="publishedAt"/>
        <result column="outer_color" property="outerColor"/>
        <result column="inner_color" property="innerColor"/>
    </resultMap>

    <select id="selectPoemsByBookId" parameterType="INT" resultType="com.cgm.poemnow.domain.Poem">
        SELECT DISTINCT
            bp.poem_order,
            bp.poem_id id,
            p.title,
            p.content,
            p.author_id,
            p.created_at,
            p.updated_at,
            p.published,
            p.published_at,
            p.like_cnt,
            p.view_cnt,
            p.unknown
        FROM book_poem bp, poem p
        WHERE bp.book_id = #{id} and bp.poem_id = p.id
        ORDER BY bp.poem_order ASC
    </select>

    <select id="selectAllBooks" resultType="com.cgm.poemnow.domain.Book">
        SELECT * from book
    </select>

    <insert id="insertBook" parameterType="com.cgm.poemnow.domain.Book">
        INSERT INTO book
            (
             title,
             author,
             outer_color,
             inner_color
            )
        VALUES
            (
             #{title},
             #{author},
             #{outerColor},
             #{innerColor}
            )
    </insert>

    <insert id="insertBookPoem" parameterType="java.util.Map">
        INSERT INTO book_poem
            (
             book_id,
             poem_id,
             poem_order
            )
        VALUES
            <foreach item="item" index="index" collection="list" separator=",">
                (#{item.bookId}, #{item.poemId}, #{item.poemOrder})
            </foreach>
    </insert>

    <select id="selectBookById" parameterType="int" resultMap="bookMap">
        SELECT *
        FROM book
        WHERE id = #{id}
    </select>

    <select id="selectRecentBook" resultType="INT">
        SELECT MAX(id)
        FROM book
    </select>

    <update id="updateBook" parameterType="com.cgm.poemnow.domain.Book">
        UPDATE book
        SET title = #{title}
        WHERE id = #{id}
    </update>

    <delete id="deleteBook" parameterType="int">
        DELETE
        FROM book
        WHERE id = #{id}
    </delete>

    <delete id="deleteBookPoem" parameterType="com.cgm.poemnow.domain.Book">
        DELETE
        FROM book_poem
        WHERE book_id = #{id}
    </delete>

</mapper>